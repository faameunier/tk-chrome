class PolicyManager{constructor(){}static async run(){let a=this.buildWindows();this.backfillRuns(a);let b=Object.keys(a),c=_.map(b,b=>this.runWindow(a,b)),d=await Promise.all(c),e=Date.now(),f=!1;for(var g=0;g<b.length;g++)d[g]&&(memoryManager.runtime_events.last_policy_runs[b[g]]=e,f=!0);f&&(await memoryManager.save())}static buildWindows(){return _.groupBy(memoryManager.tabs,a=>a.windowId)}static backfillRuns(a){let b=Date.now(),c=Object.keys(memoryManager.runtime_events.last_policy_runs),d=Object.keys(a),e=_.difference(d,c);for(var f=0;f<e.length;f++)memoryManager.runtime_events.last_policy_runs[e[f]]=b}static async runWindow(a,b){let c=a[b];if(c.length>memoryManager.settings.policy.target_tabs&&this.exponentialTrigger(c,b)){c=_.filter(c,a=>a.active==memoryManager.settings.policy.active&&a.pinned==memoryManager.settings.policy.pinned&&a.audible==memoryManager.settings.policy.audible);let a=await Promise.all(_.map(c,a=>Scorer.score(a)));a=_.zip(_.map(c,a=>a.tabId),a),a.sort((a,b)=>a[1]>b[1]?1:-1),logger(b.toString().concat(" window scored: ",JSON.stringify(a)));let e=a.shift()[0];for(var d=0;0<a.length;){let b=a.pop()[1];b===MAXIMUM_SCORE&&(d+=1)}if(d<c.length-memoryManager.settings.policy.target_tabs)return await this.killTab(e,_.find(c,a=>a.tabId===e)),!0}return!1}static async killTab(a,b){try{let c=new Promise((b,c)=>{chrome.tabs.remove(parseInt(a),function(){let a=chrome.runtime.lastError;a?c("Tab not found"):b()})});await c,memoryManager.closed_history.push(copy(b)),memoryManager.closed_history=memoryManager.closed_history.slice(0,MAXIMUM_HISTORY_SIZE),logger("Tab ".concat(a," killed by policy"))}catch(b){logger("Tab ".concat(a," not found"))}}static exponentialTrigger(a,b){let c=a.length,d=memoryManager.runtime_events.last_policy_runs[b];return Date.now()-memoryManager.runtime_events.last_policy_runs[b]>=memoryManager.settings.policy.min_time*Math.pow(memoryManager.settings.policy.decay,Math.max(0,c-memoryManager.settings.policy.target_tabs))}}